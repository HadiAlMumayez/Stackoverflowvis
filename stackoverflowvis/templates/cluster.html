<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clusters</title>
    {% load static %}

    <link href="{% static "/vendor/bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">
    <link href="{% static "/css/style.css" %}" rel="stylesheet">

<style>

    body {
        font-family: sans-serif, Arial;
        font-size: 12px;
        font-weight: bold;
    }
    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    path {
        fill-opacity: .1;
        stroke-opacity: 1;
    }

    svg{
      background: #fff;;
       width: 100%;
      height: 100%;
      display: block; 
    margin: 0 auto;
    }

    .dl-mt-100{
      margin-top: 100px;
    }

</style>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse text-center" id="navbarNav">
        <ul class="navbar-nav mx-auto">
            <li class="nav-item">
                <a class="nav-link" href="about">Home</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Charts
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item" href="chartTemp">Posts/Users</a>
                  <a class="dropdown-item" href="chart">Top tags</a>
                </div>
            </li>

            
            <li class="nav-item dropdown active">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Network Graphs
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item" href="graph">Graphs</a>
                  <a class="dropdown-item active" href="cluster">Clusters</a>
                </div>
            </li>

           
            <li class="nav-item">
                <a class="nav-link" href="heatmap">Heatmap</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="worldmap">World Map</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Posts
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="table-titles">Title topics</a>
                  <a class="dropdown-item" href="table-features">Features table</a>
                  <a class="dropdown-item" href="tag-cloud">Tag Cloud</a>
                </div>
            </li>

        </ul>
    </div>
</nav>

<div class="container">
    <div class="row dl-mt-100">
      <div class="col-md-6">
          <svg width="400" height="300"></svg>
      </div>
      <div class="col-md-6">
          <div class="md-4">
              <h4>Clusters</h4>
              <p>Clustering  Stack Overflow top 10 tags in 2018-2019</p>
          </div>
          <div class="">
            <table class="table table-light" id="clusterTable">
              <tr>
                <th>Tag</th>
                <th>Top related tags</th>
                <th>Color</th>
              </tr>

              <tr>
                <td>javascript</td>
                <td>html,react.js,arrays,node.js,php,angular,vue.js</td>
                <td>1</td>
              </tr>
              <tr>
                  <td>python</td>
                  <td>python-3.x,pandas,django,list,regex,numpy,arrays,string</td>
                  <td>5</td>
              </tr>
              <tr>
                  <td>java</td>
                  <td>android,spring,arrays,spring-boot,json,selenium,string</td>
                  <td>2</td>
              </tr>
              <tr>
                  <td>c#</td>
                  <td>.net,asp.net,wpf,unity3d,linq,asp.net-core,asp.net-mvc,winforms,json,sql,entity-framework</td>
                  <td>4</td>
              </tr>
              <tr>
                  <td>php</td>
                  <td>laravel,mysql,arrays,html,wordpress,jquery,codeigniter,regex,sql,symfony</td>
                  <td>6</td>
              </tr>
              <tr>
                  <td>android</td>
                  <td>android-studio,kotlin,firebase,android-layout,android-recyclerview,android-fragments,xml</td>
                  <td>3</td>
              </tr>
              <tr>
                  <td>sql</td>
                  <td>sql-server,oracle,postgresql,database,ms-access</td>
                  <td>9</td>
              </tr>
              <tr>
                  <td>c++</td>
                  <td>c++11,arrays,templates,c,qt,string,pointers,class,multithreading,algorithm,vector</td>
                  <td>8</td>
              </tr>
              <tr>
                  <td>html</td>
                  <td>css,angular</td>
                  <td>7</td>
              </tr>
              <tr>
                  <td>r</td>
                  <td>dplyr,dataframe,ggplot2,regex,data.table,list,loops,shiny,function,for-loop</td>
                  <td>0</td>
              </tr>
              
            </table>
          </div>
      </div>
    </div>
</div>


<!-- /.container -->
<script src={% static "js/jquery-3.2.1.min.js" %}></script>
<script src={% static "vendor/bootstrap/js/bootstrap.min.js" %}></script>
<script src='https://d3js.org/d3.v4.min.js'></script>
<script>
    var svg = d3.select('svg'),
        width = svg.attr('width'),
        height = svg.attr('height'),
        color = d3.scaleOrdinal(d3.schemeCategory20),
        valueline = d3.line()
            .x(function(d) { return d[0]; })
            .y(function(d) { return d[1]; })
            .curve(d3.curveCatmullRomClosed),
        paths,
        groups,
        groupIds,
        scaleFactor = 1,
        polygon,
        centroid,
        node,
        link,
        curveTypes = ['curveBasisClosed', 'curveCardinalClosed', 'curveCatmullRomClosed', 'curveLinearClosed'],
        simulation = d3.forceSimulation()
            .force('link', d3.forceLink().id(function(d) { return d.id; }))
            .force('charge', d3.forceManyBody())
            .force('center', d3.forceCenter(width/1.5, height/1.5))
            .force("forceX", d3.forceX())
            .force("forceY", d3.forceY());

            simulation.on('end', function() { 
                // var data3 = [];

                // var data2 = {
                //     'source' : '',
                //     'target' : [],
                //     'group' : ''
                //   };

                // $.each(_data.links, function(index, value){
                //   var tag1 = value.source;

                //   data2.source = value.source;
                //   data2.target.push(value.target);
                //   data2.group = value.group;

                //   $.each(data3, function(i,v){
                //     if(v.source === tag1){
                     
                //     }else{
                //       data3.push(data2);
                //       return false;
                //     }
                  
                //   });
                //   data3.push(data2);
                // });

                // console.log(data3);
            });

    var _data;

    function appendRow(tag1, tag2, group){
      var $table = $('#clusterTable');

      $table.append('<tr>'+
        '<td>'+tag1+'</td>'+
        '<td>'+tag2+'</td>'+
        '<td>'+group+'</td>'+
        +'</tr>');
    }

    d3.json('/static/data/cluster-5-temp.json', function(error, graph) {
        if (error) throw error;
        var edges = [];

        _data = graph;
        // create selector for curve types
        var select = d3.select('#curveSettings')
            .append('select')
            .attr('class','select')
            .on('change', function() {
                var val = d3.select('select').property('value');
                d3.select('#curveLabel').text(val);
                valueline.curve(d3[val]);
                updateGroups();
            });
        var options = select
            .selectAll('option')
            .data(curveTypes).enter()
            .append('option')
            .text(function (d) { return d; });


        // create groups, links and nodes
        groups = svg.append('g').attr('class', 'groups');

        graph.links.forEach(function(e) {
              var sourceNode = graph.nodes.filter(function(n) {
                if(n.id === e.source && n.group === e.group){
                  return n;
                }
                
              })[0],
              targetNode = graph.nodes.filter(function(n) {
                if(n.id === e.target && n.group === e.group){
                  return n;
                }
                
              })[0], 
              val = e.value;

            edges.push({
                source: sourceNode,
                target: targetNode,
                value: val
            });
          });

        link = svg.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(edges)
            .enter().append('line')
            .attr('stroke-width', function(d) { return 4; });

        node = svg.append('g')
            .attr('class', 'nodes')
            .selectAll('circle')
            .data(graph.nodes)
            .enter().append('circle')
            .attr('r', 6)
            .attr('fill', function(d) { return color(d.group); })
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // count members of each group. Groups with less
        // than 3 member will not be considered (creating
        // a convex hull need 3 points at least)
        groupIds = d3.set(graph.nodes.map(function(n) { return +n.group; }))
            .values()
            .map( function(groupId) {
                return {
                    groupId : groupId,
                    count : graph.nodes.filter(function(n) { return +n.group == groupId; }).length
                };
            })
            .filter( function(group) { return group.count > 2;})
            .map( function(group) { return group.groupId; });

        paths = groups.selectAll('.path_placeholder')
            .data(groupIds, function(d) { return +d; })
            .enter()
            .append('g')
            .attr('class', 'path_placeholder')
            .append('path')
            .attr('stroke', function(d) { return color(d); })
            .attr('fill', function(d) { return color(d)

; })
            .attr('opacity', 0);

        paths
            .transition()
            .duration(1)
            .attr('opacity', 1);

        // add interaction to the groups
        groups.selectAll('.path_placeholder')
            .call(d3.drag()
                .on('start', group_dragstarted)
                .on('drag', group_dragged)
                .on('end', group_dragended)
            );

        node.append('title')
            .text(function(d) { return d.id; });

        link.append("title")
            .text(function (d) { return d.value; });
                
        simulation
            .nodes(graph.nodes)
            .on('tick', ticked)
            .force('link')
            .links(edges);

        function ticked() {
            link
                .attr('x1', function(d) { return d.source.x; })
                .attr('y1', function(d) { return d.source.y; })
                .attr('x2', function(d) { return d.target.x; })
                .attr('y2', function(d) { return d.target.y; });
            node
                .attr('cx', function(d) { return d.x; })
                .attr('cy', function(d) { return d.y; });

            updateGroups();
        }

        


    });



    // select nodes of the group, retrieve its positions
    // and return the convex hull of the specified points
    // (3 points as minimum, otherwise returns null)
    var polygonGenerator = function(groupId) {
        var node_coords = node
            .filter(function(d) { return d.group == groupId; })
            .data()
            .map(function(d) { return [d.x, d.y]; });

        return d3.polygonHull(node_coords);
    };



    function updateGroups() {
        groupIds.forEach(function(groupId) {
            var path = paths.filter(function(d) { return d == groupId;})
                .attr('transform', 'scale(1) translate(0,0)')
                .attr('d', function(d) {
                    polygon = polygonGenerator(d);
                    centroid = d3.polygonCentroid(polygon);

                    // to scale the shape properly around its points:
                    // move the 'g' element to the centroid point, translate
                    // all the path around the center of the 'g' and then
                    // we can scale the 'g' element properly
                    return valueline(
                        polygon.map(function(point) {
                            return [  point[0] - centroid[0], point[1] - centroid[1] ];
                        })
                    );
                });

            d3.select(path.node().parentNode).attr('transform', 'translate('  + centroid[0] + ',' + (centroid[1]) + ') scale(' + scaleFactor + ')');
        });
    }


    // drag nodes
    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    // drag groups
    function group_dragstarted(groupId) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d3.select(this).select('path').style('stroke-width', 1);
    }

    function group_dragged(groupId) {
        node
            .filter(function(d) { return d.group == groupId; })
            .each(function(d) {
                d.x += d3.event.dx;
                d.y += d3.event.dy;
            })
    }

    function group_dragended(groupId) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d3.select(this).select('path').style('stroke-width', 1);
    }

</script>

</body>
</html>
